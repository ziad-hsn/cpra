{{template "layouts/base.html" .}}

{{define "title"}}Dashboard - CPRA Monitoring{{end}}

{{define "content"}}
<div class="dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard__header">
        <div class="dashboard__header-content">
            <h2 class="dashboard__title">Monitoring Dashboard</h2>
            <p class="dashboard__subtitle">Real-time health monitoring for {{.TotalMonitors}} endpoints</p>
        </div>
        
        <div class="dashboard__actions">
            <button class="btn btn--secondary" id="refresh-btn" aria-label="Refresh dashboard">
                <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M8 3a5 5 0 104.546 2.914.5.5 0 01.908-.417A6 6 0 118 2v1z" fill="currentColor"/>
                    <path d="M8 4.466V.534a.25.25 0 01.41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 018 4.466z" fill="currentColor"/>
                </svg>
                <span>Refresh</span>
            </button>
            
            <a href="/monitors/new" class="btn btn--primary">
                <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M8 4a.5.5 0 01.5.5v3h3a.5.5 0 010 1h-3v3a.5.5 0 01-1 0v-3h-3a.5.5 0 010-1h3v-3A.5.5 0 018 4z" fill="currentColor"/>
                </svg>
                <span>Add Monitor</span>
            </a>
        </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card stat-card--success">
            <div class="stat-card__icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-.997-6l7.07-7.071-1.414-1.414-5.656 5.657-2.829-2.829-1.414 1.414L11.003 16z" fill="#00D563"/>
                </svg>
            </div>
            <div class="stat-card__content">
                <div class="stat-card__value" id="healthy-count">{{.HealthyCount}}</div>
                <div class="stat-card__label">Healthy</div>
            </div>
            <div class="stat-card__trend stat-card__trend--up" role="status" aria-label="Trend: up">
                <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
                    <path d="M6 3l3 3H7v3H5V6H3l3-3z" fill="currentColor"/>
                </svg>
                <span>{{.HealthyTrend}}%</span>
            </div>
        </div>
        
        <div class="stat-card stat-card--warning">
            <div class="stat-card__icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z" fill="#FFB020"/>
                </svg>
            </div>
            <div class="stat-card__content">
                <div class="stat-card__value" id="warning-count">{{.WarningCount}}</div>
                <div class="stat-card__label">Warning</div>
            </div>
        </div>
        
        <div class="stat-card stat-card--error">
            <div class="stat-card__icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z" fill="#E50914"/>
                </svg>
            </div>
            <div class="stat-card__content">
                <div class="stat-card__value" id="error-count">{{.ErrorCount}}</div>
                <div class="stat-card__label">Critical</div>
            </div>
            {{if gt .ErrorCount 0}}
            <div class="stat-card__alert" role="alert">
                <span class="pulse-dot"></span>
            </div>
            {{end}}
        </div>
        
        <div class="stat-card">
            <div class="stat-card__icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2zm0 5a1 1 0 00-1 1v4a1 1 0 00.293.707l2.5 2.5a1 1 0 001.414-1.414L13 11.586V8a1 1 0 00-1-1z" fill="currentColor"/>
                </svg>
            </div>
            <div class="stat-card__content">
                <div class="stat-card__value" id="avg-response">{{.AvgResponseTime}}ms</div>
                <div class="stat-card__label">Avg Response</div>
            </div>
        </div>
    </div>
    
    <!-- Monitors Grid -->
    <div class="dashboard__section">
        <div class="section-header">
            <h3 class="section-header__title">Active Monitors</h3>
            <div class="section-header__actions">
                <div class="filter-group" role="group" aria-label="Filter monitors">
                    <button class="filter-btn filter-btn--active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="http">HTTP</button>
                    <button class="filter-btn" data-filter="tcp">TCP</button>
                    <button class="filter-btn" data-filter="icmp">ICMP</button>
                    <button class="filter-btn" data-filter="docker">Docker</button>
                </div>
                
                <label for="sort-select" class="sr-only">Sort by</label>
                <select id="sort-select" class="select-input">
                    <option value="status">Sort by Status</option>
                    <option value="name">Sort by Name</option>
                    <option value="response">Sort by Response Time</option>
                    <option value="uptime">Sort by Uptime</option>
                </select>
            </div>
        </div>
        
        <div class="monitors-grid" id="monitors-grid">
            {{range .Monitors}}
            <article class="monitor-card monitor-card--{{.Status}}" data-type="{{.Type}}" data-id="{{.ID}}">
                <div class="monitor-card__header">
                    <div class="monitor-card__status">
                        <span class="status-dot status-dot--{{.Status}}" role="img" aria-label="Status: {{.Status}}"></span>
                        <span class="monitor-card__type-badge">{{.Type}}</span>
                    </div>
                    <button class="btn btn--ghost btn--icon" aria-label="Monitor options" data-menu="{{.ID}}">
                        <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                            <path d="M3 8a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm6 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm6 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                
                <div class="monitor-card__content">
                    <h4 class="monitor-card__title">
                        <a href="/monitors/{{.ID}}">{{.Name}}</a>
                    </h4>
                    <p class="monitor-card__endpoint">{{.Endpoint}}</p>
                </div>
                
                <div class="monitor-card__metrics">
                    <div class="metric">
                        <span class="metric__label">Uptime</span>
                        <span class="metric__value">{{.Uptime}}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric__label">Response</span>
                        <span class="metric__value">{{.ResponseTime}}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric__label">Last Check</span>
                        <time class="metric__value" datetime="{{.LastCheckISO}}">{{.LastCheck}}</time>
                    </div>
                </div>
                
                <div class="monitor-card__sparkline" aria-label="Response time trend">
                    <svg width="100%" height="40" viewBox="0 0 100 40" preserveAspectRatio="none">
                        <polyline points="{{.SparklinePoints}}" 
                                  stroke="{{.SparklineColor}}" 
                                  stroke-width="2" 
                                  fill="none"/>
                    </svg>
                </div>
                
                {{if .ErrorMessage}}
                <div class="monitor-card__error" role="alert">
                    <svg width="14" height="14" viewBox="0 0 14 14" aria-hidden="true">
                        <path d="M7 0a7 7 0 100 14A7 7 0 007 0zm.875 10.5h-1.75v-1.75h1.75v1.75zm0-3.5h-1.75v-5.25h1.75V7z" fill="currentColor"/>
                    </svg>
                    <span>{{.ErrorMessage}}</span>
                </div>
                {{end}}
            </article>
            {{else}}
            <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 64 64" aria-hidden="true">
                    <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2" fill="none" opacity="0.2"/>
                    <path d="M32 16v16m0 4v4" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
                <h3 class="empty-state__title">No monitors configured</h3>
                <p class="empty-state__text">Add your first monitor to start tracking uptime</p>
                <a href="/monitors/new" class="btn btn--primary">Add Monitor</a>
            </div>
            {{end}}
        </div>
    </div>
    
    <!-- Recent Alerts -->
    <div class="dashboard__section">
        <div class="section-header">
            <h3 class="section-header__title">Recent Alerts</h3>
            <a href="/alerts" class="section-header__link">View All</a>
        </div>
        
        <div class="alerts-list" id="recent-alerts">
            {{range .RecentAlerts}}
            <div class="alert-item alert-item--{{.Severity}}">
                <div class="alert-item__icon" aria-hidden="true">
                    {{if eq .Severity "critical"}}
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" fill="currentColor"/>
                    </svg>
                    {{else if eq .Severity "warning"}}
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" fill="currentColor"/>
                    </svg>
                    {{else}}
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" fill="currentColor"/>
                    </svg>
                    {{end}}
                </div>
                <div class="alert-item__content">
                    <h4 class="alert-item__title">{{.Title}}</h4>
                    <p class="alert-item__message">{{.Message}}</p>
                    <time class="alert-item__time" datetime="{{.TimestampISO}}">{{.Timestamp}}</time>
                </div>
                {{if not .Acknowledged}}
                <button class="btn btn--sm btn--ghost" data-ack="{{.ID}}">Acknowledge</button>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state empty-state--sm">
                <p>No recent alerts</p>
            </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// Server-Sent Events for real-time updates
const evtSource = new EventSource('/api/events/dashboard');

evtSource.addEventListener('monitor-update', (e) => {
    const data = JSON.parse(e.data);
    updateMonitorCard(data);
});

evtSource.addEventListener('stats-update', (e) => {
    const data = JSON.parse(e.data);
    updateStats(data);
});

evtSource.addEventListener('alert', (e) => {
    const data = JSON.parse(e.data);
    showToast(data);
    addAlertToList(data);
});

function updateMonitorCard(data) {
    const card = document.querySelector(`[data-id="${data.id}"]`);
    if (!card) return;
    
    // Update status
    card.className = `monitor-card monitor-card--${data.status}`;
    const statusDot = card.querySelector('.status-dot');
    statusDot.className = `status-dot status-dot--${data.status}`;
    
    // Update metrics
    card.querySelector('.metric__value:nth-child(2)').textContent = `${data.uptime}%`;
    card.querySelector('.metric__value:nth-child(4)').textContent = `${data.responseTime}ms`;
    
    // Announce update to screen readers
    const announcement = document.createElement('div');
    announcement.className = 'sr-only';
    announcement.setAttribute('role', 'status');
    announcement.setAttribute('aria-live', 'polite');
    announcement.textContent = `Monitor ${data.name} status updated to ${data.status}`;
    document.body.appendChild(announcement);
    setTimeout(() => announcement.remove(), 1000);
}

function updateStats(data) {
    document.getElementById('healthy-count').textContent = data.healthy;
    document.getElementById('warning-count').textContent = data.warning;
    document.getElementById('error-count').textContent = data.error;
    document.getElementById('avg-response').textContent = `${data.avgResponse}ms`;
}

function showToast(data) {
    const container = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast--${data.severity}`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="toast__icon" aria-hidden="true">
            ${getAlertIcon(data.severity)}
        </div>
        <div class="toast__content">
            <div class="toast__title">${data.title}</div>
            <div class="toast__message">${data.message}</div>
        </div>
        <button class="toast__close" aria-label="Close notification">Ã—</button>
    `;
    
    container.appendChild(toast);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        toast.classList.add('toast--exit');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
    
    // Manual dismiss
    toast.querySelector('.toast__close').addEventListener('click', () => {
        toast.classList.add('toast--exit');
        setTimeout(() => toast.remove(), 300);
    });
}

function getAlertIcon(severity) {
    // Return SVG based on severity
    // Implementation matches the alert icons above
    return ''; // Simplified for brevity
}

// Filter monitors
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-btn--active'));
        e.target.classList.add('filter-btn--active');
        
        const filter = e.target.dataset.filter;
        const cards = document.querySelectorAll('.monitor-card');
        
        cards.forEach(card => {
            if (filter === 'all' || card.dataset.type === filter) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// Refresh button
document.getElementById('refresh-btn')?.addEventListener('click', () => {
    window.location.reload();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    evtSource.close();
});
</script>
{{end}}
